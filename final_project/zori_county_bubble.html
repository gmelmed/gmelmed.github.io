<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Bubble Map with Tooltip</title>
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.js"></script>
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.css" rel="stylesheet">
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v4.7.0/mapbox-gl-geocoder.min.js"></script>
    <link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v4.7.0/mapbox-gl-geocoder.css" type="text/css" />
    <style>
        @font-face {
            font-family: 'Gotham-Book';
            src: url('https://raw.githubusercontent.com/gmelmed/gmelmed.github.io/main/final_project/fonts/Gotham-Book.otf') format('opentype');
        }

        @font-face {
            font-family: 'Gotham-BoldItalic';
            src: url('https://raw.githubusercontent.com/gmelmed/gmelmed.github.io/main/final_project/fonts/Gotham-BoldItalic.otf') format('opentype');
        }

        @font-face {
            font-family: 'Gotham-Bold';
            src: url('https://raw.githubusercontent.com/gmelmed/gmelmed.github.io/main/final_project/fonts/Gotham-Bold.otf') format('opentype');
        }

        body { margin: 0; padding: 0; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; }

        .tooltip {
            position: absolute;
            background: rgba(255, 255, 255, 0.9);
            padding: 10px;
            border-radius: 5px;
            pointer-events: none;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
            font-family: 'Gotham-Book', sans-serif;
            font-size: 1.015em;
            z-index: 1500;
        }

        .tooltip .name {
            font-family: 'Gotham-Bold', sans-serif;
            font-size: 1.015em;
        }

        .tooltip .value {
            font-family: 'Gotham-BoldItalic', sans-serif;
        }

        .tooltip .value.positive {
            color: #d7301f;
        }

        .tooltip .value.negative {
            color: #5e3c99;
        }

        .legend {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: white;
            padding: 8px;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            font-family: 'Gotham-Book', sans-serif;
            font-size: 0.85em;
            max-width: 180px;
        }

        .legend-item, .size-benchmark {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }

        .legend-item:last-child, .size-benchmark:last-child {
            margin-bottom: 0;
        }

        .legend-color, .size-bubble {
            width: 16px;
            height: 16px;
            margin-right: 8px;
        }

        .size-bubble {
            border: 1px solid #333;
            border-radius: 50%;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <div class="tooltip" id="tooltip" style="display: none;"></div>
    <div class="legend" id="legend"></div>

    <script>
        mapboxgl.accessToken = 'pk.eyJ1IjoiZ21lbG1lZCIsImEiOiJjbTNleXo5ajQwa3pyMmxzOGM0dzR2MTRqIn0.DoIpFl0U8bAf5XcclnywBA';
        const map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/gmelmed/cm3ez4qa6000901sgc3b7393y',
            center: [-98.5795, 39.8283],
            zoom: 4
        });
    
        const nav = new mapboxgl.NavigationControl();
        map.addControl(nav, 'top-right');
    
        const geocoder = new MapboxGeocoder({
            accessToken: mapboxgl.accessToken,
            mapboxgl: mapboxgl,
            placeholder: 'Search for a state or location...',
            zoom: 5,
            marker: false
        });
    
        geocoder.on('result', (e) => {
            map.flyTo({
                center: e.result.center,
                zoom: 6,
                essential: true
            });
        });
    
        map.addControl(geocoder, 'top-left');
    
        const tooltip = document.getElementById('tooltip');
        const legend = document.getElementById('legend');
    
        d3.csv('https://raw.githubusercontent.com/gmelmed/gmelmed.github.io/refs/heads/main/final_project/zori_county_long_clean.csv')
            .then(data => {
                const mostRecentDate = d3.max(data, d => d.date);
                const filteredData = data.filter(d => d.date === mostRecentDate);
    
                // Quantile-based color scale for positive values
                const positiveValues = filteredData.filter(d => +d.zori_1yc >= 0).map(d => +d.zori_1yc);
                const colorScalePositive = d3.scaleQuantile()
                    .domain(positiveValues)
                    .range(['#fef0d9','#fdcc8a','#fc8d59','#d7301f']); // Corresponding colors
    
                const getColor = d => {
                    if (d < 0) return '#5e3c99'; // Fixed color for negative values
                    return colorScalePositive(d); // Quantile-based color for positive values
                };
    
                // Add legend
                legend.innerHTML = `<h4>Change in rent index since ${new Date(mostRecentDate).toLocaleString('default', { month: 'long', year: 'numeric' })}</h4>`;
                legend.innerHTML += `
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #5e3c99;"></div>
                        <div>Below 0%</div>
                    </div>
                `;
    
                const quantileBreakpoints = colorScalePositive.quantiles(); // Quantile breakpoints for positive values
                const legendColors = colorScalePositive.range();
                quantileBreakpoints.unshift(0); // Add the zero breakpoint
                quantileBreakpoints.push(d3.max(positiveValues)); // Add the maximum value
    
                legendColors.forEach((color, i) => {
                    legend.innerHTML += `
                        <div class="legend-item">
                            <div class="legend-color" style="background-color: ${color};"></div>
                            <div>${quantileBreakpoints[i].toFixed(1)}% to ${quantileBreakpoints[i + 1].toFixed(1)}%</div>
                        </div>
                    `;
                });
    
                // Sort data to layer smaller points on top
                filteredData.sort((a, b) => +b.pop_2023 - +a.pop_2023);
    
                filteredData.forEach(d => {
                    const popupContent = `
                        <div>
                            <div class="name">${d.name}</div>
                            <div>Rent Index: <span class="value">$${(+d.zori).toFixed(1)}</span></div>
                            <div>1-Yr Change: <span class="value ${+d.zori_1yc > 0 ? 'positive' : 'negative'}">${(+d.zori_1yc).toFixed(1)}%</span></div>
                        </div>
                    `;
    
                    const el = document.createElement('div');
                    el.className = 'marker';
                    el.style.width = `${Math.sqrt(+d.pop_2023) * 0.035}px`;
                    el.style.height = `${Math.sqrt(+d.pop_2023) * 0.035}px`;
                    el.style.backgroundColor = getColor(+d.zori_1yc);
                    el.style.opacity = '0.5';
                    el.style.border = '1px solid #333';
                    el.style.borderRadius = '50%';
    
                    const marker = new mapboxgl.Marker(el)
                        .setLngLat([+d.lng, +d.lat])
                        .addTo(map);
    
                    el.addEventListener('mouseenter', () => {
                        el.style.opacity = '1';
                        tooltip.style.display = 'block';
                        tooltip.innerHTML = popupContent;
                    });
                    el.addEventListener('mouseleave', () => {
                        el.style.opacity = '0.5';
                        tooltip.style.display = 'none';
                    });
                    el.addEventListener('mousemove', (e) => {
                        tooltip.style.left = `${e.pageX + 10}px`;
                        tooltip.style.top = `${e.pageY + 10}px`;
                    });
                });
            })
            .catch(error => console.error('Error loading the data:', error));
    </script>
    
</body>
</html>
