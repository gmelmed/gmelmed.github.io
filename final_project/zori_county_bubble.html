<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>Bubble Map with Tooltip</title>
        <script src="https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.js"></script>
        <link href="https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.css" rel="stylesheet">
        <script src="https://d3js.org/d3.v7.min.js"></script>
        <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v4.7.0/mapbox-gl-geocoder.min.js"></script>
        <link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v4.7.0/mapbox-gl-geocoder.css" type="text/css" />
        <style>
            @font-face {
                font-family: 'Gotham-Book';
                src: url('https://raw.githubusercontent.com/gmelmed/gmelmed.github.io/main/final_project/fonts/Gotham-Book.otf') format('opentype');
            }
    
            @font-face {
                font-family: 'Gotham-BoldItalic';
                src: url('https://raw.githubusercontent.com/gmelmed/gmelmed.github.io/main/final_project/fonts/Gotham-BoldItalic.otf') format('opentype');
            }
    
            @font-face {
                font-family: 'Gotham-Bold';
                src: url('https://raw.githubusercontent.com/gmelmed/gmelmed.github.io/main/final_project/fonts/Gotham-Bold.otf') format('opentype');
            }

            @font-face {
                font-family: 'GothamRnd-Bold';
                src: url('https://raw.githubusercontent.com/gmelmed/gmelmed.github.io/main/final_project/fonts/GothamRnd-Bold.otf') format('opentype');
            }
    
            body { margin: 0; padding: 0; }
            #map { position: absolute; top: 0; bottom: 0; width: 100%; }
    
            .reset-button {
                position: absolute;
                top: 50px;
                left: 10px;
                background: white;
                padding: 6px 10px;
                border: none;
                border-radius: 4px;
                box-shadow: 0 0 0 2px rgba(0,0,0,0.1);
                cursor: pointer;
                font-family: 'Gotham-Book', sans-serif;
                font-size: 12px;
            }
    
            .reset-button:hover {
                background: #f0f0f0;
            }
    
            .tooltip {
                position: absolute;
                background: rgba(255, 255, 255, 0.9);
                padding: 10px;
                border-radius: 5px;
                pointer-events: none;
                box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
                font-family: 'Gotham-Book', sans-serif;
                font-size: 1.015em;
                z-index: 1500;
            }
    
            .tooltip .name {
                font-family: 'GothamRnd-Bold', sans-serif;
                font-size: 1.015em;
            }
    
            .tooltip .value {
                font-family: 'GothamRnd-Bold', sans-serif;
            }
    
            .tooltip .value.positive {
                color: #d7301f;
            }
    
            .tooltip .value.negative {
                color: #5e3c99;
            }
    
            .legend {
                position: absolute;
                bottom: 20px;
                right: 20px;
                background: white;
                padding: 8px;
                border-radius: 5px;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
                font-family: 'Gotham-Book', sans-serif;
                font-size: 0.85em;
                max-width: 180px;
            }
    
            .legend-item, .size-benchmark {
                display: flex;
                align-items: center;
                margin-bottom: 5px;
            }
    
            .legend-item:last-child, .size-benchmark:last-child {
                margin-bottom: 0;
            }
    
            .legend-color, .size-bubble {
                width: 16px;
                height: 16px;
                margin-right: 8px;
            }
    
            .size-bubble {
                border: 1px solid #333;
                border-radius: 50%;
            }
        </style>
    </head>
<body>
    <div id="map"></div>
    <div class="tooltip" id="tooltip" style="display: none;"></div>
    <div class="legend" id="legend"></div>

    <script>
        mapboxgl.accessToken = 'pk.eyJ1IjoiZ21lbG1lZCIsImEiOiJjbTNleXo5ajQwa3pyMmxzOGM0dzR2MTRqIn0.DoIpFl0U8bAf5XcclnywBA';
        const map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/gmelmed/cm3ez4qa6000901sgc3b7393y',
            center: [-98.5795, 39.8283],
            zoom: 4
        });
    
        const nav = new mapboxgl.NavigationControl();
        map.addControl(nav, 'top-right');
    
        const geocoder = new MapboxGeocoder({
            accessToken: mapboxgl.accessToken,
            mapboxgl: mapboxgl,
            placeholder: 'Search for a state or location...',
            zoom: 4,
            marker: false
        });
    
        geocoder.on('result', (e) => {
            map.flyTo({
                center: e.result.center,
                zoom: 6,
                essential: true
            });
        });
    
        map.addControl(geocoder, 'top-left');

        // Create reset button
        const resetButton = document.createElement('button');
        resetButton.className = 'reset-button';
        resetButton.textContent = 'Reset Map View';
        resetButton.style.left = '10px'; // Align with geocoder
        resetButton.style.top = '50px';  // Position below geocoder

        // Add click handler
        resetButton.addEventListener('click', () => {
            map.flyTo({
                center: [-98.5795, 39.8283], // Your initial center coordinates
                zoom: 3.5,                     // Your initial zoom level
                essential: true
            });
        });

        // Add button to map container
        document.getElementById('map').appendChild(resetButton);
    
        const tooltip = document.getElementById('tooltip');
        const legend = document.getElementById('legend');
    
        map.on('load', () => {
            // Add a data source
            map.addSource('points', {
                type: 'geojson',
                data: {
                    type: 'FeatureCollection',
                    features: []
                }
            });
    
            // Base circle layer for all points
            map.addLayer({
                'id': 'rent-points',
                'type': 'circle',
                'source': 'points',
                'paint': {
                    'circle-radius': [
                        'sqrt',
                        ['/', ['get', 'population'], 2500]
                    ],
                    'circle-color': ['get', 'color'],
                    'circle-opacity': 0.5,
                    'circle-stroke-width': 1,
                    'circle-stroke-color': '#333',
                    'circle-stroke-opacity': 0.5
                }
            });
    
            // Hover layer - will only show the hovered point
            map.addLayer({
                'id': 'rent-points-hover',
                'type': 'circle',
                'source': 'points',
                'paint': {
                    'circle-radius': [
                        'sqrt',
                        ['/', ['get', 'population'], 2500]
                    ],
                    'circle-color': ['get', 'color'],
                    'circle-opacity': 1.0,
                    'circle-stroke-width': 1,
                    'circle-stroke-color': '#333',
                    'circle-stroke-opacity': 1.0
                },
                'filter': ['==', ['id'], '']  // Start with no points visible
            });
    
            // Load and process the data
            d3.csv('https://raw.githubusercontent.com/gmelmed/gmelmed.github.io/refs/heads/main/final_project/zori_county_long_clean.csv')
                .then(data => {
                    const mostRecentDate = d3.max(data, d => d.date);
                    const filteredData = data.filter(d => d.date === mostRecentDate);
    
                    // Quantile-based color scale for positive values
                    const positiveValues = filteredData.filter(d => +d.zori_1yc >= 0).map(d => +d.zori_1yc);
                    const colorScalePositive = d3.scaleQuantile()
                        .domain(positiveValues)
                        .range(['#fef0d9','#fdcc8a','#fc8d59','#d7301f']);
    
                    const getColor = d => {
                        if (d < 0) return '#5e3c99';
                        return colorScalePositive(d);
                    };
    
                    // Convert data to GeoJSON
                    const geojson = {
                        type: 'FeatureCollection',
                        features: filteredData.map(d => ({
                            type: 'Feature',
                            properties: {
                                name: d.name,
                                zori: +d.zori,
                                zori_1yc: +d.zori_1yc,
                                population: +d.pop_2023,
                                color: getColor(+d.zori_1yc)
                            },
                            geometry: {
                                type: 'Point',
                                coordinates: [+d.lng, +d.lat]
                            }
                        }))
                    };
    
                    // Update the source data
                    map.getSource('points').setData(geojson);
    
                    // Update hover interactions
                    map.on('mousemove', 'rent-points', (e) => {
                        if (e.features.length > 0) {
                            const feature = e.features[0];
                            
                            map.getCanvas().style.cursor = 'pointer';
                            
                            // Update the filter to show only the hovered point in the hover layer
                            map.setFilter('rent-points-hover', ['==', ['id'], feature.id]);

                            // Show tooltip with color-matched value
                            tooltip.style.display = 'block';
                            tooltip.style.left = `${e.point.x + 10}px`;
                            tooltip.style.top = `${e.point.y + 10}px`;
                            tooltip.innerHTML = `
                                <div>
                                    <div class="name">${feature.properties.name}</div>
                                    <div>Rent Index: <span class="value">$${feature.properties.zori.toFixed(1)}</span></div>
                                    <div>YoY Change: <span style="color: ${feature.properties.color}; font-family: 'GothamRnd-Bold', sans-serif;">${feature.properties.zori_1yc.toFixed(1)}%</span></div>
                                </div>
                            `;
                        }
                    });
    
                    map.on('mouseleave', 'rent-points', () => {
                        map.getCanvas().style.cursor = '';
                        tooltip.style.display = 'none';
                        // Clear the hover layer
                        map.setFilter('rent-points-hover', ['==', ['id'], '']);
                    });
    
                    // Add legend
                    // Create date object for one year before most recent date
                    const oneYearAgo = new Date(mostRecentDate);
                    oneYearAgo.setFullYear(oneYearAgo.getFullYear() - 1);

                    // Add legend with one year ago date
                    legend.innerHTML = `<h4>Change in rent index since ${oneYearAgo.toLocaleString('default', { month: 'long', year: 'numeric' })}</h4>`;
                    legend.innerHTML += `
                        <div class="legend-item">
                            <div class="legend-color" style="background-color: #5e3c99;"></div>
                            <div>Below 0%</div>
                        </div>
                    `;

                    const quantileBreakpoints = colorScalePositive.quantiles();
                    const legendColors = colorScalePositive.range();
                    quantileBreakpoints.unshift(0);
                    quantileBreakpoints.push(d3.max(positiveValues));

                    legendColors.forEach((color, i) => {
                        legend.innerHTML += `
                            <div class="legend-item">
                                <div class="legend-color" style="background-color: ${color};"></div>
                                <div>${quantileBreakpoints[i].toFixed(1)}% to ${quantileBreakpoints[i + 1].toFixed(1)}%</div>
                            </div>
                        `;
                    });

                    // Add separator between color and size legends
                    legend.innerHTML += `<hr style="margin: 10px 0; border: none; border-top: 1px solid #ccc;">`;

                    // Add size legend title
                    legend.innerHTML += `<h4 style="margin-top: 10px; margin-bottom: 5px;">Population</h4>`;

                    // Add size legend items
                    const populationSizes = [100000, 500000, 1000000]; // Example population sizes
                    populationSizes.forEach(pop => {
                        const radius = Math.sqrt(pop / 2500); // Same formula as in the circle radius
                        legend.innerHTML += `
                            <div class="size-benchmark">
                                <div class="size-bubble" style="width: ${radius * 2}px; height: ${radius * 2}px;"></div>
                                <div>${(pop/1000000).toFixed(1)}M</div>
                            </div>
                        `;
                    });
                })
                .catch(error => console.error('Error loading the data:', error));
        });
    </script>
</body>
</html>